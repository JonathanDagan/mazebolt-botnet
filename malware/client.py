# /bin/python3

import requests # TODO: switch to indipendent from requests
import subprocess
from time import sleep

BASE_URL = 'http://localhost:8000'

while True:
    sleep(5)
    csrf_token = requests.get(f'{BASE_URL}').cookies['csrftoken']
    res = requests.get(f'{BASE_URL}/attacks')
    attacks = res.json()
    for attack in attacks:
        if attack['status'] == 'NEW':
            command = attack['command']
            print('stating command')
            requests.post(f'{BASE_URL}/attacks/{attack["id"]}/start', headers={'X-CSRFToken': csrf_token})            
            
            print('running the command')
            subprocess.Popen(command, shell=True)
            
            print('finished command')
            requests.post(f'{BASE_URL}/attacks/{attack["id"]}/finish', headers={'X-CSRFToken': csrf_token})

